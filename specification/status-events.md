# 8. Events

## Overview
An **Event** is a discrete, timestamped occurrence that reflects a change in the state, condition, or behavior of a
**Resource**. Events provide fine-grained, diagnostic details for the progression of an **Incident** (e.g., transitions
between `up`, `degraded`, and `down`). Events are immutable records useful for audits and timelines.

## Attributes
| Attribute       | Type           | Description                                                                 | Required | Example |
|-----------------|----------------|-----------------------------------------------------------------------------|----------|---------|
| `id`            | string         | Unique identifier (UUID).                                                   | yes      | `003e33cd-fa5e-43f8-8670-e4681c41559a` |
| `self_uri`      | URI            | Canonical hyperlink to this Event.                                         | yes      | `http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a` |
| `name`          | string         | Long name/title of the Event.                                              | yes      | `Global Homes` |
| `description`   | string         | Human-readable description of the Event.                                   | no       | `global_homes is UP` |
| `last_modified` | date-time      | Timestamp (ISO 8601) when this Event was last modified.                    | yes      | `2025-05-24T17:04:30.000Z` |
| `status`        | StatusType     | Status at the time of the event.                                           | yes      | `up` |
| `occurred_at`   | date-time      | Timestamp (ISO 8601) when the event occurred.                              | no       | `2025-05-24T17:04:30.276Z` |
| `resource_uri`  | URI            | Hyperlink to the impacted **Resource**.                                    | yes      | `http://localhost:8081/api/v1/status/resources/ff415c87-6596-41c7-93fd-b772994a92d4` |
| `incident_uri`  | URI            | Hyperlink to the generating **Incident**.                                  | yes      | `http://localhost:8081/api/v1/status/incidents/82c413be-3d2b-47aa-97ff-8611a11f0182` |

### ENUM StatusType
`up`, `degraded`, `down`, `unknown`

## Relationships to other resources
| Attribute      | Source | Relationship | Destination | Description                          |
|----------------|--------|--------------|-------------|--------------------------------------|
| `self_uri`     | Event  | self         | Event       | Self-reference.                      |
| `resource_uri` | Event  | impacts      | Resource    | Event impacts a Resource.            |
| `incident_uri` | Event  | generatedBy  | Incident    | Event generated by an Incident.      |

## Endpoints
| Method | Path                                 | Description                            | Idempotency |
|--------|--------------------------------------|----------------------------------------|-------------|
| GET    | `/api/v1/status/events`              | Retrieve a collection of events        | Yes (safe)  |
| GET    | `/api/v1/status/events/{event_id}` | Retrieve a single event by ID          | Yes (safe)  |

## Request & Response Semantics

### Headers
- `Authorization: Bearer <token>` — OAuth 2.0 bearer token (provider dependent).
- `If-Modified-Since: <HTTP-date>` — Conditional GET on `last_modified`; `304 Not Modified` if unchanged (RFC 9110).
- `Last-Modified: <HTTP-date>` — Response header indicating the event's or collection's most recent modification time.
- `Content-Location: <URI>` — Response header identifying the URI of the returned representation (RFC 9110).

### Path params
- `event_id` — UUID of the target Event.

### Query params (collection)
- `name` — filter by exact event name (case-insensitive).
- `status` — filter by `StatusType`.
- `from` — return events with `occurred_at >=` this timestamp (ISO 8601).
- `to` — return events with `occurred_at <=` this timestamp (ISO 8601).
- `modified_since` — return events with `last_modified >` this timestamp.
- `offset` (default `0`) — pagination start index.
- `limit` (default `100`) — page size.

### Security model (authN/authZ)
- OAuth 2.0 bearer tokens; `401` if unauthenticated, `403` if not authorized.

### State transitions / invariants
- Read-only `GET` operations.
- Conditional requests supported: if `If-Modified-Since` is present and no items/event are newer than the time provided,
  server returns `304 Not Modified` without a body.

## Examples

### Successful response example(s)

#### _`event` Collection GET `/api/v1/status/events` (paginated)_
```http
GET /api/v1/status/events?limit=2&offset=0 HTTP/1.1
Accept: application/json
Authorization: Bearer <token>
```

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Location: http://localhost:8081/api/v1/status/events?limit=2&offset=0
Last-Modified: 2025-05-24T17:04:30.000Z
```

```json
{
  "items": [
    {
      "id": "003e33cd-fa5e-43f8-8670-e4681c41559a",
      "self_uri": "http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a",
      "name": "Global Homes",
      "description": "global_homes is UP",
      "last_modified": "2025-05-24T17:04:30.000Z",
      "status": "up",
      "occurred_at": "2025-05-24T17:04:30.276Z",
      "resource_uri": "http://localhost:8081/api/v1/status/resources/ff415c87-6596-41c7-93fd-b772994a92d4",
      "incident_uri": "http://localhost:8081/api/v1/status/incidents/82c413be-3d2b-47aa-97ff-8611a11f0182"
    },
    {
      "id": "0023820c-046a-4ed8-9948-18dae99e4a07",
      "self_uri": "http://localhost:8081/api/v1/status/events/0023820c-046a-4ed8-9948-18dae99e4a07",
      "name": "sfapi is down",
      "description": "Down event for resource a0d96526-6fd3-413e-8f9e-ff12d602539e",
      "last_modified": "2025-05-28T03:34:25.000Z",
      "status": "down",
      "resource_uri": "http://localhost:8081/api/v1/status/resources/a0d96526-6fd3-413e-8f9e-ff12d602539e",
      "incident_uri": "http://localhost:8081/api/v1/status/incidents/319f6a91-07bc-4f3a-8c5c-4721e18cfde9"
    }
  ],
  "offset": 0,
  "limit": 2,
  "count": 2,
  "total": 2,
  "_links": {
    "self": {
      "href": "http://localhost:8081/api/v1/status/events?limit=2&offset=0"
    },
    "next": {
      "href": "http://localhost:8081/api/v1/status/events?limit=2&offset=2"
    }
  }
}
```

#### _`event` Item GET `/api/v1/status/events/{event_id}`_
```http
GET http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a HTTP/1.1
Accept: application/json
Authorization: Bearer <token>
```

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Location: http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a
Last-Modified: 2025-05-24T17:04:30.000Z
```

```json
{
  "id": "003e33cd-fa5e-43f8-8670-e4681c41559a",
  "self_uri": "http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a",
  "name": "Global Homes",
  "description": "global_homes is UP",
  "last_modified": "2025-05-24T17:04:30.000Z",
  "status": "up",
  "occurred_at": "2025-05-24T17:04:30.276Z",
  "resource_uri": "http://localhost:8081/api/v1/status/resources/ff415c87-6596-41c7-93fd-b772994a92d4",
  "incident_uri": "http://localhost:8081/api/v1/status/incidents/82c413be-3d2b-47aa-97ff-8611a11f0182"
}
```

#### _Conditional GET via `If-Modified-Since`_
```http
GET http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a HTTP/1.1
Accept: application/json
If-Modified-Since: 2025-06-01T00:00:00Z
```

```http
HTTP/1.1 304 Not Modified
Last-Modified: 2025-05-24T17:04:30.000Z
```

#### _Filtered GET by `status`_
```http
GET /api/v1/status/events?status=down HTTP/1.1
Accept: application/json
```

#### _Filtered GET by time range (`from`/`to`)_
```http
GET /api/v1/status/events?from=2025-05-01T00:00:00Z&to=2025-05-31T23:59:59Z HTTP/1.1
Accept: application/json
```

### Error examples (Problem Details, RFC 9457)
- **400 Bad Request** — invalid parameter:
```http
HTTP/1.1 400 Bad Request
Content-Type: application/problem+json
```

```json
{
  "type": "https://example.com/problems/invalid-parameter",
  "title": "Invalid request parameter",
  "status": 400,
  "detail": "Parameter 'status' must be one of: up, degraded, down, unknown",
  "instance": "http://localhost:8081/api/v1/status/events?status=bogus"
}
```

- **401 Unauthorized**:
```json
{
  "type": "https://example.com/problems/unauthorized",
  "title": "Missing or invalid token",
  "status": 401,
  "detail": "Bearer token is missing, expired, or invalid",
  "instance": "http://localhost:8081/api/v1/status/events"
}
```

- **403 Forbidden**:
```json
{
  "type": "https://example.com/problems/forbidden",
  "title": "Insufficient permissions",
  "status": 403,
  "detail": "The authenticated principal is not authorized to access this resource",
  "instance": "http://localhost:8081/api/v1/status/events"
}
```

- **404 Not Found**:
```json
{
  "type": "https://example.com/problems/not-found",
  "title": "Event not found",
  "status": 404,
  "detail": "No event found with id 'deadbeef-0000-0000-0000-000000000000'",
  "instance": "http://localhost:8081/api/v1/status/events/deadbeef-0000-0000-0000-000000000000"
}
```

- **409 Conflict** (generic example for consistency):
```json
{
  "type": "https://example.com/problems/conflict",
  "title": "Conflicting parameters",
  "status": 409,
  "detail": "Only one of 'from' and 'modified_since' may be used for time filtering",
  "instance": "http://localhost:8081/api/v1/status/events?from=2025-05-01T00:00:00Z&modified_since=2025-05-02T00:00:00Z"
}
```

- **500 Internal Server Error**:
```json
{
  "type": "about:blank",
  "title": "Internal Server Error",
  "status": 500,
  "detail": "An unexpected error occurred",
  "instance": "http://localhost:8081/api/v1/status/events"
}
```

## OpenAPI 3.1 Snippet
A minimal OAS 3.1 description scoped to the Events resource. Error responses follow **RFC 9457**
`application/problem+json`.

```yaml
openapi: 3.1.0
info:
  title: IRI Facility Status API
  version: v1
  description: Event endpoints for the IRI Facility Status API.
servers:
  - url: http://localhost:8081
paths:
  /api/v1/status/events:
    get:
      summary: Retrieve a collection of events
      operationId: getEvents
      tags: [status, events]
      parameters:
        - name: accept
          in: header
          schema: { type: string, default: application/json }
        - name: If-Modified-Since
          in: header
          schema: { type: string, format: date-time }
        - name: modified_since
          in: query
          schema: { type: string, format: date-time }
        - name: name
          in: query
          schema: { type: string }
        - name: status
          in: query
          schema: { type: string, enum: [up, degraded, down, unknown] }
        - name: from
          in: query
          schema: { type: string, format: date-time }
        - name: to
          in: query
          schema: { type: string, format: date-time }
        - name: offset
          in: query
          schema: { type: integer, minimum: 0, default: 0 }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, default: 100 }
      responses:
        '200':
          description: Successful response
          headers:
            Content-Location: { schema: { type: string, format: uri } }
            Last-Modified: { schema: { type: string, format: date-time } }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventCollection'
        '304':
          description: Not Modified
          headers:
            Last-Modified: { schema: { type: string, format: date-time } }
        '400': { $ref: '#/components/responses/Problem400' }
        '401': { $ref: '#/components/responses/Problem401' }
        '403': { $ref: '#/components/responses/Problem403' }
        '500': { $ref: '#/components/responses/Problem500' }
      security:
        - bearerAuth: []
  /api/v1/status/events/{event_id}:
    get:
      summary: Retrieve a single event by ID
      operationId: getEvent
      tags: [status, events]
      parameters:
        - name: accept
          in: header
          schema: { type: string, default: application/json }
        - name: If-Modified-Since
          in: header
          schema: { type: string, format: date-time }
        - name: modified_since
          in: query
          schema: { type: string, format: date-time }
        - name: event_id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Successful response
          headers:
            Content-Location: { schema: { type: string, format: uri } }
            Last-Modified: { schema: { type: string, format: date-time } }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '304':
          description: Not Modified
          headers:
            Last-Modified: { schema: { type: string, format: date-time } }
        '401': { $ref: '#/components/responses/Problem401' }
        '403': { $ref: '#/components/responses/Problem403' }
        '404': { $ref: '#/components/responses/Problem404' }
        '500': { $ref: '#/components/responses/Problem500' }
      security:
        - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Event:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        self_uri: { type: string, format: uri }
        name: { type: string }
        description: { type: string }
        last_modified: { type: string, format: date-time }
        status: { type: string, enum: [up, degraded, down, unknown] }
        occurred_at: { type: string, format: date-time }
        resource_uri: { type: string, format: uri }
        incident_uri: { type: string, format: uri }
      required: [id, self_uri, name, last_modified, status, resource_uri]
      example: {
          "id": "003e33cd-fa5e-43f8-8670-e4681c41559a",
          "self_uri": "http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a",
          "name": "Global Homes",
          "description": "global_homes is UP",
          "last_modified": "2025-05-24T17:04:30.000Z",
          "status": "up",
          "occurred_at": "2025-05-24T17:04:30.276Z",
          "resource_uri": "http://localhost:8081/api/v1/status/resources/ff415c87-6596-41c7-93fd-b772994a92d4",
          "incident_uri": "http://localhost:8081/api/v1/status/incidents/82c413be-3d2b-47aa-97ff-8611a11f0182"
        }
    EventCollection:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Event' }
        offset: { type: integer, minimum: 0 }
        limit: { type: integer, minimum: 1 }
        count: { type: integer, minimum: 0 }
        total: { type: integer, minimum: 0 }
        _links: { type: object, additionalProperties: true }
      required: [items]
      example: {
          "items": [
            {
              "id": "003e33cd-fa5e-43f8-8670-e4681c41559a",
              "self_uri": "http://localhost:8081/api/v1/status/events/003e33cd-fa5e-43f8-8670-e4681c41559a",
              "name": "Global Homes",
              "description": "global_homes is UP",
              "last_modified": "2025-05-24T17:04:30.000Z",
              "status": "up",
              "occurred_at": "2025-05-24T17:04:30.276Z",
              "resource_uri": "http://localhost:8081/api/v1/status/resources/ff415c87-6596-41c7-93fd-b772994a92d4",
              "incident_uri": "http://localhost:8081/api/v1/status/incidents/82c413be-3d2b-47aa-97ff-8611a11f0182"
            },
            {
              "id": "0023820c-046a-4ed8-9948-18dae99e4a07",
              "self_uri": "http://localhost:8081/api/v1/status/events/0023820c-046a-4ed8-9948-18dae99e4a07",
              "name": "sfapi is down",
              "description": "Down event for resource a0d96526-6fd3-413e-8f9e-ff12d602539e",
              "last_modified": "2025-05-28T03:34:25.000Z",
              "status": "down",
              "resource_uri": "http://localhost:8081/api/v1/status/resources/a0d96526-6fd3-413e-8f9e-ff12d602539e",
              "incident_uri": "http://localhost:8081/api/v1/status/incidents/319f6a91-07bc-4f3a-8c5c-4721e18cfde9"
            }
          ],
          "offset": 0,
          "limit": 2,
          "count": 2,
          "total": 2,
          "_links": {
            "self": {
              "href": "http://localhost:8081/api/v1/status/events?limit=2&offset=0"
            },
            "next": {
              "href": "http://localhost:8081/api/v1/status/events?limit=2&offset=2"
            }
          }
        }
  responses:
    Problem400:
      description: Bad Request
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem401:
      description: Unauthorized
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem403:
      description: Forbidden
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem404:
      description: Not Found
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem500:
      description: Internal Server Error
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
```

## Notes & Decisions
- **Versioning.** Both endpoints are exposed under `/api/v1/...` for stability.
- **Pagination.** `offset` + `limit` paging on the sorted-by-id list per implementation.
- **Filtering.** `status` applies to the event’s status at occurrence; `from`/`to` filter on `occurred_at`; `modified_since`
  filters on `last_modified`.
- **Caching.** Conditional GET with `If-Modified-Since` is supported; responses include `Last-Modified` and `Content-Location`.

## Changelog
- 2025-10-15 — Initial draft for Events based on `docs/status-resources.md` and `StatusController.java`.

## Standards Referenced
- HTTP Semantics (RFC 9110).
- Problem Details for HTTP APIs (RFC 9457).
- OpenAPI 3.1.0; JSON Schema 2020-12.

---

**Sources (from attached repo):**
- `docs/status-resources.md`
- `src/main/java/net/es/iri/api/facility/StatusController.java`
- `src/main/java/net/es/iri/api/facility/schema/Event.java`
- `src/main/java/net/es/iri/api/facility/schema/NamedObject.java`
- `examples/events.json`
